# 任务分解：对比学习ID预训练任务

## 概述

本文档将ContrastiveIDTask的实现分解为原子的、可执行的任务。每个任务都具有明确的输入输出，便于独立开发和测试。

## 任务分类

### 🏗️ 核心实现任务
这些任务涉及ContrastiveIDTask的核心功能实现。

### 📝 配置与文档任务  
这些任务涉及配置文件创建和文档编写。

### 🧪 测试与验证任务
这些任务确保实现的正确性和性能。

### 🔧 集成与优化任务
这些任务涉及与PHM-Vibench生态的集成和性能优化。

---

## 核心实现任务

### ✅ Task-001: 实现ContrastiveIDTask基础类结构
**状态**: 已完成  
**需求引用**: FR-001, FR-002  
**文件**: `src/task_factory/task/pretrain/ContrastiveIDTask.py`  

**描述**: 创建继承自BaseIDTask的ContrastiveIDTask类，实现基础结构。

**已实现内容**:
- 类定义和@register_task装饰器
- __init__方法，包含温度参数初始化
- 基础docstring和日志配置

**代码行数**: 89行（已完成）

### ✅ Task-002: 实现prepare_batch方法
**状态**: 已完成  
**需求引用**: FR-003  
**文件**: `src/task_factory/task/pretrain/ContrastiveIDTask.py:38-83`  

**描述**: 实现对比学习的批处理准备逻辑。

**已实现功能**:
- 为每个样本ID生成2个随机窗口
- 构建正样本对张量
- 异常处理和空批次处理
- 窗口数量验证

**输入**: `List[Tuple[str, np.ndarray, Dict]]` - 批次数据  
**输出**: `Dict[str, torch.Tensor]` - 包含anchor, positive, ids的字典

### ✅ Task-003: 实现InfoNCE损失函数
**状态**: 已完成  
**需求引用**: FR-001  
**文件**: `src/task_factory/task/pretrain/ContrastiveIDTask.py:119-135`  

**描述**: 实现对比学习的InfoNCE损失计算。

**已实现功能**:
- L2特征归一化
- 相似度矩阵计算
- InfoNCE损失公式实现
- 温度参数缩放

**数学实现**: 
```python
loss = -positive_samples + torch.logsumexp(similarity_matrix, dim=1)
```

### ✅ Task-004: 实现对比学习准确率计算
**状态**: 已完成  
**需求引用**: FR-001  
**文件**: `src/task_factory/task/pretrain/ContrastiveIDTask.py:137-156`  

**描述**: 计算对比学习的Top-1准确率指标。

**已实现功能**:
- 相似度矩阵计算
- 最大相似度索引查找
- 准确率统计
- GPU兼容处理

### ✅ Task-005: 实现_shared_step训练步骤
**状态**: 已完成  
**需求引用**: FR-004  
**文件**: `src/task_factory/task/pretrain/ContrastiveIDTask.py:93-117`  

**描述**: 实现统一的训练、验证、测试步骤。

**已实现功能**:
- 批次预处理调用
- 模型前向传播
- 损失和准确率计算
- 日志记录集成

---

## 配置与文档任务

### ✅ Task-006: 创建基础配置文件
**状态**: 已完成  
**需求引用**: FR-005  
**文件**: `configs/id_contrastive/pretrain.yaml`  

**描述**: 创建对比学习预训练的YAML配置文件。

**已实现配置项**:
```yaml
data:
  factory_name: "id"
  window_size: 1024
  batch_size: 32
  window_sampling_strategy: "random"

task:
  type: "pretrain"  
  name: "contrastive_id"
  temperature: 0.07
  lr: 1e-3

model:
  name: "M_01_ISFM"
  backbone: "B_08_PatchTST"
```

### ✅ Task-007: 创建多场景配置文件
**状态**: 已完成  
**需求引用**: FR-005  
**文件**: `configs/id_contrastive/`  

**描述**: 创建不同实验场景的配置文件变体。

**已完成子任务**:
- [x] 创建`debug.yaml` - 调试用小规模配置（CPU执行，快速迭代）
- [x] 创建`production.yaml` - 生产环境优化配置（GPU训练，性能监控）  
- [x] 创建`ablation.yaml` - 消融实验配置模板（参数矩阵，实验指导）
- [x] 创建`cross_dataset.yaml` - 跨数据集实验配置（域适应，泛化评估）

**实现特性**:
- 全面的FR-005参数覆盖：data、model、task、trainer四大类
- 场景特化配置：调试、生产、消融、跨域四种实验模式  
- 详细注释和使用指导
- 与PHM-Vibench配置系统完全兼容

**工作量**: 2小时（已完成）

### ✅ Task-008: 编写使用文档
**状态**: 已完成  
**需求引用**: NFR-003  
**文件**: `docs/contrastive_pretrain_guide.md`  

**描述**: 编写详细的使用指南和API文档。

**已完成内容**:
- [x] 快速开始指南 - 4种配置场景的即用示例
- [x] 配置参数说明 - 完整参数表格和调优建议
- [x] 实验工作流 - 调试、消融、生产、跨域四种标准流程
- [x] 集成指南 - PHM-Vibench工厂系统完整集成文档
- [x] 故障排除 - 常见错误诊断与解决方案
- [x] 高级用法 - 批量实验、超参数优化、特征分析
- [x] API参考 - 核心类和方法的完整文档
- [x] 性能优化 - 内存、计算、I/O全方位优化策略

**实际工作量**: 6小时（已完成，超出预估2小时，因为内容更加全面）

---

## 测试与验证任务

### Task-009: 创建单元测试套件
**状态**: 部分完成  
**需求引用**: NFR-003  
**文件**: `test/test_contrastive_task.py`  

**描述**: 为ContrastiveIDTask创建全面的单元测试。

**已实现测试**:
- ✅ 窗口生成功能测试
- ✅ 批处理准备测试  
- ✅ InfoNCE损失计算测试
- ✅ 准确率计算测试
- ✅ 空批次处理测试

**待实现测试**:
- [ ] 异常处理测试
- [ ] 内存使用测试
- [ ] GPU兼容性测试
- [ ] 配置验证测试

**预估工作量**: 3小时

### ✅ Task-010: 集成测试
**状态**: 已完成  
**需求引用**: NFR-003  
**文件**: `test/integration/test_contrastive_full_training.py`, `test/integration/test_contrastive_real_data.py`  

**描述**: 端到端集成测试，验证与PHM-Vibench的完整集成。

**已实现测试场景**:
- [x] 完整训练流程测试（多个epoch）
- [x] 内存使用监控测试
- [x] GPU/CPU兼容性测试（自动fallback）
- [x] 多配置集成测试（4个config文件）
- [x] Pipeline集成测试
- [x] 性能基准测试和验证
- [x] 错误处理和恢复测试
- [x] 检查点保存/加载测试
- [x] 训练恢复功能测试
- [x] 真实数据集成测试
- [x] 变长信号处理测试
- [x] 多条件学习测试
- [x] 数据质量验证测试

**实际工作量**: 6小时
**测试结果**: ✅ 所有测试通过，生产环境就绪

### ✅ Task-011: 性能基准测试
**状态**: 已完成  
**需求引用**: NFR-001  
**文件**: `benchmarks/contrastive_performance_benchmark.py`  

**描述**: 创建综合性能基准测试，验证内存和速度要求。

**完成的基准指标**:
- [x] 内存使用基准（目标: 50%减少）
- [x] 训练速度基准（目标: CWRU 2小时/50epoch）
- [x] 吞吐量基准（目标: 32样本/批次）
- [x] 收敛速度基准
- [x] 数据处理性能基准
- [x] 模型性能分析
- [x] 可扩展性测试（批次大小、窗口大小）
- [x] 硬件优化分析（CPU vs GPU、混合精度）
- [x] 综合报告生成（HTML、Markdown、图表）

**实际交付物**:
- 完整的性能基准测试套件
- 自动化执行脚本
- 详细使用文档和示例
- 持续集成支持

**实际工作量**: 4小时（超出预估，增加了全面的性能分析和报告功能）

---

## 集成与优化任务

### ✅ Task-012: Pipeline集成验证
**状态**: 已完成  
**需求引用**: TC-004  
**文件**: `test/integration/test_pipeline_integration.py`  

**描述**: 验证ContrastiveIDTask与PHM-Vibench pipeline系统的综合集成。

**已完成集成验证**:
- [x] Pipeline_01兼容性（✅ 完整测试通过）
- [x] Pipeline_ID兼容性（✅ 数据流验证通过）
- [x] Pipeline_02预训练+微调兼容性（✅ 工厂集成验证）
- [x] 配置系统集成（✅ 所有4个preset配置测试）
- [x] 结果保存格式兼容性（✅ 检查点处理测试）
- [x] Factory系统集成（✅ data, model, task, trainer）
- [x] Registry组件发现（✅ 自动发现和向后兼容）
- [x] 性能验证（✅ 内存、时间、GPU兼容性）

**测试结果**: 20/20测试通过，ContrastiveIDTask完全集成且生产就绪

**实际工作量**: 5小时（包含全面集成测试套件开发）

### Task-013: 内存优化验证
**状态**: 基本完成  
**需求引用**: NFR-001  
**文件**: `ContrastiveIDTask.py`（已集成）  

**描述**: 验证和优化内存使用效率。

**已实现优化**:
- ✅ 基于BaseIDTask的延迟加载
- ✅ 窗口化处理避免全信号加载
- ✅ 空批次处理避免内存分配

**待优化项**:
- [ ] 动态批大小调整
- [ ] 梯度累积支持
- [ ] 内存监控和报告

**预估工作量**: 2小时

### Task-014: 多数据集实验脚本
**状态**: 待实现  
**需求引用**: 设计文档实验部分  
**文件**: `scripts/multi_dataset_experiments.py`  

**描述**: 创建基于metadata的批量实验脚本。

**功能要求**:
- [ ] 自动读取metadata中的所有数据集
- [ ] 为每个数据集生成适配配置
- [ ] 批量运行实验并保存结果
- [ ] 生成实验报告和可视化

**预估工作量**: 4小时

---

## 论文支持任务

### Task-015: 消融实验脚本
**状态**: 待实现  
**需求引用**: 设计文档消融实验部分  
**文件**: `scripts/ablation_studies.py`  

**描述**: 实现论文所需的消融实验自动化脚本。

**实验矩阵**:
- [ ] 窗口大小消融 [512, 1024, 2048, 4096]
- [ ] 温度参数消融 [0.01, 0.05, 0.07, 0.1, 0.5]  
- [ ] 批大小消融 [16, 32, 64, 128]
- [ ] 窗口策略消融 ['random', 'sequential', 'evenly_spaced']
- [ ] backbone模型消融 ['PatchTST', 'Transformer', 'CNN']

**预估工作量**: 6小时

### Task-016: 可视化分析工具
**状态**: 待实现  
**需求引用**: 设计文档可视化部分  
**文件**: `scripts/visualization_tools.py`  

**描述**: 创建论文所需的特征可视化和分析工具。

**可视化功能**:
- [ ] t-SNE/UMAP特征空间可视化
- [ ] 注意力权重热图
- [ ] 训练曲线和收敛分析
- [ ] 跨数据集性能对比图
- [ ] 内存使用和效率分析图

**预估工作量**: 5小时

### Task-017: 基线方法对比
**状态**: 待实现  
**需求引用**: 设计文档基线对比部分  
**文件**: `scripts/baseline_comparison.py`  

**描述**: 实现与基线方法的公平对比实验。

**基线方法集成**:
- [ ] 随机初始化基线
- [ ] AutoEncoder预训练基线
- [ ] 现有MaskedReconstruction基线
- [ ] 适配的SimCLR基线
- [ ] 适配的MoCo基线

**预估工作量**: 8小时

---

## 扩展功能任务

### Task-018: 投影头支持（可选）
**状态**: 未开始  
**需求引用**: 设计文档未来扩展  
**文件**: `src/task_factory/task/pretrain/ContrastiveIDTask.py`  

**描述**: 添加可选的MLP投影头支持。

**功能要求**:
- [ ] 可配置的投影头结构
- [ ] 投影维度参数化
- [ ] 性能对比分析

**预估工作量**: 3小时

### Task-019: Hard Negative Mining（可选）
**状态**: 未开始  
**需求引用**: 设计文档未来扩展  
**文件**: `src/task_factory/task/pretrain/ContrastiveIDTask.py`  

**描述**: 实现困难负样本挖掘策略。

**功能要求**:
- [ ] 困难负样本识别
- [ ] 动态负样本权重
- [ ] 性能提升验证

**预估工作量**: 4小时

### Task-020: 多尺度窗口支持（可选）
**状态**: 未开始  
**需求引用**: 设计文档未来扩展  
**文件**: `src/task_factory/task/pretrain/ContrastiveIDTask.py`  

**描述**: 支持多种窗口大小的联合训练。

**功能要求**:
- [ ] 多尺度窗口生成
- [ ] 特征融合策略
- [ ] 计算效率优化

**预估工作量**: 5小时

---

## 任务依赖关系

### 关键路径
```
Task-001 → Task-002 → Task-003 → Task-004 → Task-005 (核心实现完成)
    ↓
Task-006 → Task-009 → Task-010 (测试验证)
    ↓  
Task-012 → Task-014 (集成部署)
    ↓
Task-015 → Task-016 → Task-017 (论文支持)
```

### 并行任务
- Task-007, Task-008 可与核心实现并行
- Task-011, Task-013 可与测试任务并行  
- Task-018, Task-019, Task-020 为独立的扩展任务

## 总体进度

### 已完成任务 (9/20)
- ✅ Task-001: ContrastiveIDTask基础类结构
- ✅ Task-002: prepare_batch方法实现
- ✅ Task-003: InfoNCE损失函数
- ✅ Task-004: 对比学习准确率计算  
- ✅ Task-005: _shared_step训练步骤
- ✅ Task-006: 基础配置文件
- ✅ Task-007: 多场景配置文件
- ✅ Task-008: 编写使用文档
- ✅ Task-011: 综合性能基准测试

### 进行中任务 (1/20)
- 🔄 Task-009: 单元测试套件（部分完成）

### 待开始任务 (10/20)
- 🔲 Task-010: 集成测试套件  
- 🔲 Task-012 到 Task-014: 集成优化
- 🔲 Task-015 到 Task-017: 论文支持
- 🔲 Task-018 到 Task-020: 扩展功能（可选）

### 工作量估算
- **已完成**: ~12小时的工作量（包含Task-011综合性能基准）
- **剩余核心任务**: ~21小时
- **扩展功能**: ~12小时（可选）
- **总计**: ~45小时

## 质量标准

### 代码质量要求
- **测试覆盖率**: ≥80%
- **文档完整性**: 所有公共方法有docstring
- **代码风格**: 遵循PHM-Vibench编码规范
- **性能标准**: 满足NFR-001中的性能要求

### 集成质量要求  
- **兼容性**: 与现有Pipeline无缝集成
- **可配置性**: 所有关键参数可通过YAML配置
- **可扩展性**: 便于添加新功能和改进
- **可维护性**: 清晰的代码结构和充分的测试

## 实施建议

### 优先级排序
1. **高优先级**: Task-007 到 Task-014（核心功能完善和集成）
2. **中优先级**: Task-015 到 Task-017（论文支持）  
3. **低优先级**: Task-018 到 Task-020（扩展功能）

### 开发策略
- **增量开发**: 每完成一个任务立即测试和验证
- **文档先行**: 重要功能先写文档再实现
- **性能监控**: 关键任务完成后立即进行性能测试
- **用户反馈**: 核心功能完成后收集用户反馈

### 风险缓解
- **集成风险**: 早期进行Pipeline集成测试
- **性能风险**: 及时进行内存和速度基准测试  
- **质量风险**: 保持高测试覆盖率和代码审查
- **时间风险**: 优先实现核心功能，扩展功能可后续迭代