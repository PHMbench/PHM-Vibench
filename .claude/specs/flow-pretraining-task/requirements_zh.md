# Flow预训练任务 - 需求文档

**功能名称**: flow-pretraining-task  
**创建日期**: 2025-09-01  
**状态**: 需求阶段  
**优先级**: 高

## 项目简介

本规范定义了在PHM-Vibench框架内实现基于Flow的预训练任务的需求。基于现有的M_04_ISFM_Flow模型实现，此功能将创建一个综合的预训练系统，结合Flow生成建模与对比学习，用于工业振动信号分析。该实施将作为学术研究发表的基础，为Flow预训练在故障诊断应用中提供经验证的实验结果。

## 产品愿景对齐

此功能直接支持PHM-Vibench的核心使命，为工业故障诊断方法提供标准化、可复现的基准测试：
- **生成建模集成**：为平台增加最先进的生成建模能力
- **数据增强支持**：为稀少故障类别启用合成数据生成
- **多域学习**：支持域适应和少样本学习场景  
- **研究卓越性**：提供发表级别的实验框架和结果
- **方法学进步**：为PHM研究社区贡献新颖的预训练方法

## 需求规范

### 需求1：核心Flow预训练任务实现

**用户故事**：作为研究科学家，我希望在多个工业数据集上预训练Flow模型，以便为下游故障诊断任务学习鲁棒的表征。

**描述**：实现基于PyTorch Lightning的综合预训练任务，将现有的M_04_ISFM_Flow模型与PHM-Vibench的任务工厂系统集成。

**验收标准**：
- **当**用户配置Flow预训练实验时
- **则**系统应创建集成M_04_ISFM_Flow模型的PyTorch Lightning任务
- **且**支持条件和无条件生成模式
- **且**自动处理(B,L,C)振动信号格式
- **且**与现有任务工厂注册模式无缝集成
- **且**通过YAML配置提供可配置的训练参数

### 需求2：Flow-对比学习联合系统

**用户故事**：作为研究科学家，我希望结合Flow损失与对比学习，以便提高学习表征的质量。

**描述**：开发联合损失函数系统，结合Flow重建损失与对比学习目标，以增强表征学习。

**验收标准**：
- **当**Flow预训练配置了对比学习时
- **则**系统应计算Flow重建损失和对比学习损失的组合
- **且**允许损失组件间的可配置权重(λ_flow, λ_contrastive)
- **且**支持现有ContrastiveSSL模块集成
- **且**为稳定的联合训练提供梯度平衡机制
- **且**记录独立和组合损失组件以供监控

### 需求3：多尺度验证框架  

**用户故事**：作为研究科学家，我希望在小数据集上快速验证Flow预训练，以便高效地迭代模型配置。

**描述**：提供支持不同实验尺度的综合验证框架，从快速原型设计到完整研究验证。

**验收标准**：
- **当**用户启动Flow预训练验证时
- **则**系统应提供可配置的验证尺度：
  - 小数据集快速验证（CWRU，<100轮次）
  - 中等数据集验证（CWRU+XJTU，200-500轮次） 
  - 完整多数据集训练（所有可用数据集，1000+轮次）
- **且**在所有尺度上生成一致的指标
- **且**支持早停和收敛检测
- **且**为每个尺度提供时间和资源估计

### 需求4：生成质量评估

**用户故事**：作为机器学习工程师，我希望通过综合指标监控训练进度，以便确保模型收敛和质量。

**描述**：实现Flow模型训练质量和生成样本评估的综合指标和监控。

**验收标准**：
- **当**Flow模型训练进行时
- **则**系统应计算和记录：
  - Flow重建损失收敛跟踪
  - 生成样本质量指标（与真实数据的统计相似性）
  - 下游任务性能改进测量
  - 生成与真实样本的实时可视化
- **且**在训练期间提供自动质量检查点
- **且**生成发表级别的图表和指标摘要

### 需求5：多数据集流水线集成

**用户故事**：作为机器学习工程师，我希望将Flow预训练扩展到大数据集，以便训练生产就绪的模型。

**描述**：实现与PHM-Vibench现有流水线系统和多数据集工作流的无缝集成。

**验收标准**：
- **当**Flow预训练用于多阶段流水线时
- **则**系统应支持：
  - 预训练 → 少样本学习工作流（Pipeline_02_pretrain_fewshot）
  - 预训练 → 域适应工作流
  - 预训练 → 分类微调工作流
- **且**在流水线阶段间维护检查点兼容性
- **且**支持多GPU分布式训练
- **且**处理大型多数据集场景的内存高效加载

### 需求6：研究发表支持

**用户故事**：作为博士生，我希望复现已发表的Flow预训练结果，以便在现有研究基础上构建。

**描述**：提供具有可复现性保证和发表质量输出的研究级别实验支持。

**验收标准**：
- **当**进行用于研究的Flow预训练实验时
- **则**系统应提供：
  - 通过确定性种子设定的完全可复现性
  - 综合的超参数记录和实验跟踪
  - 发表质量的可视化和指标导出
  - 与基线方法的比较分析工具
- **且**支持标准研究评估协议
- **且**生成LaTeX兼容的结果表格和图形

### 需求7：数据增强合成生成

**用户故事**：作为博士生，我希望生成合成振动信号用于数据增强，以便提高不平衡数据集上的分类性能。

**描述**：使用训练好的Flow模型实现高质量合成信号生成能力，用于数据增强应用。

**验收标准**：
- **当**Flow预训练模型成功训练后
- **则**系统应提供合成数据生成能力：
  - 基于故障类别标签的条件生成
  - 用于通用增强的无条件生成
  - 用于高效增强流水线的批量生成
  - 生成样本的质量控制机制
- **且**支持与下游分类任务的集成
- **且**提供生成与真实数据分布的统计验证

### 需求8：错误处理和模型稳定性

**用户故事**：作为机器学习工程师，我希望在长时间训练运行中具有鲁棒的错误处理，以便确保可靠的模型训练而无需人工干预。

**描述**：为生产级别训练场景实现综合错误处理、稳定性监控和容错性。

**验收标准**：
- **当**Flow预训练遇到训练不稳定时
- **则**系统应提供：
  - 梯度裁剪和数值稳定性保护
  - 自动检查点保存和恢复机制
  - 训练异常检测和警报
  - 损坏数据样本的优雅处理
- **且**支持分布式训练容错
- **且**提供详细的错误记录和诊断信息

## 非功能性需求

### 性能需求

#### 训练效率
- **当**Flow预训练在GPU上运行时
- **则**训练速度应达到>50次迭代/秒（batch_size=32）
- **且**内存使用应保持<8GB（典型配置）
- **且**支持更大有效批次大小的梯度累积

#### 可扩展性
- **当**多数据集用于预训练时
- **则**系统应同时处理多达15+个数据集
- **且**支持多GPU分布式训练
- **且**在不同数据规模下维护训练稳定性

### 质量需求

#### 可复现性
- **当**重复Flow预训练实验时
- **则**使用相同种子结果应可复现
- **且**配置文件应捕获所有实验参数
- **且**模型检查点应能够精确结果复现

#### 代码质量
- **当**开发Flow预训练代码时
- **则**所有组件应具有>95%测试覆盖率
- **且**遵循PHM-Vibench编码规范
- **且**包含综合文档字符串和类型提示

### 集成需求

#### 向后兼容性
- **当**Flow预训练添加到PHM-Vibench时
- **则**现有实验应继续正常工作
- **且**不应对核心接口引入破坏性更改
- **且**新功能应扩展而非替换当前功能

## 技术约束

### 技术栈约束
- **TC-1**：必须使用PyTorch 2.6.0+和PyTorch Lightning框架
- **TC-2**：必须与现有M_04_ISFM_Flow实现集成
- **TC-3**：必须利用现有ContrastiveSSL组件
- **TC-4**：必须支持CUDA 11.1+的GPU加速

### 数据格式约束  
- **TC-5**：必须处理标准PHM-Vibench数据格式(B,L,C)
- **TC-6**：必须与现有元数据和file_id系统配合工作
- **TC-7**：必须支持H5和原始数据加载机制

### 资源约束
- **TC-8**：必须在典型研究GPU内存限制内工作(8-24GB)
- **TC-9**：必须提供合理的训练时间(小时级，非天级)
- **TC-10**：不需要标准ML设置之外的专用硬件

## 验收标准

### 最小可行产品(MVP)
- [ ] **AC-1**：Flow预训练任务在CWRU数据集上成功训练
- [ ] **AC-2**：生成的样本在视觉上类似输入振动信号  
- [ ] **AC-3**：Flow损失在小数据集上100轮内收敛
- [ ] **AC-4**：与task_factory集成无需代码更改即可工作
- [ ] **AC-5**：配置文件遵循PHM-Vibench模式

### 增强功能
- [ ] **AC-6**：联合Flow+对比损失训练将下游任务误差减少>5%
- [ ] **AC-7**：多数据集预训练适用于3+不同数据集
- [ ] **AC-8**：生成样本改善不平衡数据上的分类性能
- [ ] **AC-9**：基础配置在单GPU上4小时内完成训练
- [ ] **AC-10**：所有组件通过综合单元和集成测试

### 研究发表就绪
- [ ] **AC-11**：在时间序列上复现已发表的Flow匹配/矫正流结果
- [ ] **AC-12**：提供与现有预训练方法的比较分析
- [ ] **AC-13**：生成发表质量的可视化和指标
- [ ] **AC-14**：包含完整实验协议和超参数日志
- [ ] **AC-15**：展示跨数据集泛化改进

## 成功指标

### 定量指标
1. **训练收敛**：Flow损失在指定轮次内收敛到<0.1
2. **生成质量**：生成样本与真实数据的统计差异<10%
3. **下游性能**：预训练将分类准确率提高3-15%
4. **训练效率**：保持>50样本/秒训练速度
5. **内存效率**：标准配置峰值内存使用<8GB

### 定性指标
1. **代码质量**：通过所有代码检查和类型检查要求
2. **文档**：完整的API文档和使用示例
3. **可复现性**：外部用户独立复现结果
4. **集成质量**：与现有PHM-Vibench组件的无缝工作流
5. **研究价值**：适合高质量学术发表

## 风险分析

### 高风险项目（概率：高，影响：高）

**R-1：Flow模型训练不稳定**（P: 0.7, I: 0.9）
- *描述*：Flow模型训练中的数值不稳定导致NaN损失或发散
- *影响*：完全训练失败，无法使用的模型，研究时间延迟
- *缓解措施*：
  - 实现梯度裁剪（max_norm=1.0）和学习率调度
  - 添加数值稳定性检查和自动回滚机制
  - 使用带损失缩放的混合精度训练
- *监控*：跟踪损失方差、梯度范数和NaN检测
- *应急计划*：回退到更保守的超参数和简化架构

**R-2：内存资源耗尽**（P: 0.6, I: 0.8）
- *描述*：多数据集训练或大批次处理期间GPU内存溢出
- *影响*：训练崩溃，实验范围减少，硬件限制
- *缓解措施*：
  - 实现梯度累积和动态批次大小调整
  - 添加内存分析和优化工具
  - 支持多GPU分布式训练
- *监控*：GPU内存使用跟踪，批次大小优化指标
- *应急计划*：减少模型大小，使用梯度检查点，云GPU扩展

### 中风险项目（概率：中等，影响：中等）

**R-3：任务工厂集成复杂性**（P: 0.4, I: 0.6）
- *描述*：与现有PHM-Vibench任务工厂模式的复杂集成
- *影响*：开发延迟，可维护性问题，破坏性更改
- *缓解措施*：
  - 遵循现有预训练任务的既定模式（masked_reconstruction.py）
  - 与现有流水线的广泛集成测试
  - PHM-Vibench维护者的代码审查
- *监控*：集成测试通过率，代码复杂度指标
- *应急计划*：简化集成方法，独立任务实现

**R-4：对比-Flow损失平衡**（P: 0.5, I: 0.5）
- *描述*：实现Flow和对比目标稳定联合训练的困难
- *影响*：次优模型性能，收敛问题，超参数敏感性
- *缓解措施*：
  - 实现自适应损失权重机制
  - 广泛的超参数搜索和消融研究
  - 冲突目标的梯度手术技术
- *监控*：独立损失组件跟踪，收敛分析
- *应急计划*：顺序训练方法，简化损失组合

### 低风险项目（概率：低，影响：低-中等）

**R-5：配置系统复杂性**（P: 0.3, I: 0.4）
- *描述*：多损失组件的复杂YAML配置管理
- *影响*：用户困惑，配置错误，可用性降低
- *缓解措施*：清晰的配置模板，验证，综合文档
- *监控*：用户反馈，配置错误率
- *应急计划*：简化配置选项，基于GUI的配置工具

**R-6：性能基准目标**（P: 0.2, I: 0.3）
- *描述*：未能达到指定性能目标（>50次迭代/秒，<8GB内存）
- *影响*：可用性降低，硬件需求增加
- *缓解措施*：早期性能分析，优化优先级
- *监控*：持续性能基准测试，资源使用跟踪
- *应急计划*：放松性能目标，硬件需求更新

## 依赖关系

### 内部依赖
- M_04_ISFM_Flow模型实现（已完成）
- ContrastiveSSL模块（可用）
- task_factory注册系统（可用）
- PHM-Vibench配置系统v5.0（可用）
- Pipeline_02_pretrain_fewshot工作流（可用）

### 外部依赖
- PyTorch 2.6.0+（可用）
- PyTorch Lightning（可用）
- WandB实验跟踪（可选）
- Matplotlib/Seaborn可视化（可用）

## 范围外

### 明确排除
- **E-1**：实时推理优化（未来增强）
- **E-2**：移动/边缘部署支持（非研究重点）
- **E-3**：Flow预训练的定制GUI（使用现有Streamlit）
- **E-4**：与非PyTorch框架的集成
- **E-5**：对非振动信号模态的支持

### 未来增强  
- **F-1**：高级Flow架构（连续归一化流）
- **F-2**：多模态预训练（振动+温度+压力）
- **F-3**：自动超参数优化
- **F-4**：跨多节点分布式训练
- **F-5**：与MLFlow的实验管理集成

---

**需求状态**：已准备好进入设计阶段  
**下一步**：基于这些需求创建技术设计文档