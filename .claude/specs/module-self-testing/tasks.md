# 任务分解：模块自测环节功能

## 概述

本文档将模块自测功能实现分解为原子的、可执行的任务。每个任务具有明确的输入输出，便于独立开发和验证，遵循CLAUDE.md中"小步提交"和"直白实现"的原则。

## 任务分类

### 🏗️ 框架建设任务
创建统一的自测框架和支持工具。

### 🔧 核心模块任务
为关键的工厂类和组件添加自测功能。

### 📦 扩展模块任务
为其他模块添加自测功能。

### ✅ 验证和优化任务
确保实现质量和性能要求。

---

## 框架建设任务

### Task-001: 创建自测框架核心
**状态**: 待实现  
**需求引用**: FR-001, FR-005  
**文件**: `src/utils/self_test_framework.py`  
**估算时间**: 2小时

**描述**: 创建SelfTestFramework类，提供统一的测试执行、结果记录和报告功能。

**验收标准**:
- [ ] 实现SelfTestFramework类
- [ ] 支持测试执行和异常处理
- [ ] 提供标准化的输出格式
- [ ] 包含性能计时功能
- [ ] 生成测试摘要报告

**输入**: 无  
**输出**: 完整的SelfTestFramework类

**实现要点**:
```python
class SelfTestFramework:
    - __init__(module_name: str)
    - run_test(test_func, test_name, *args, **kwargs)
    - print_header()
    - print_summary() -> bool
```

### Task-002: 创建Mock对象工厂
**状态**: 待实现  
**需求引用**: FR-004  
**文件**: `src/utils/mock_factory.py`  
**估算时间**: 1.5小时

**描述**: 创建MockFactory类，提供用于测试的轻量级Mock对象。

**验收标准**:
- [ ] 创建MockFactory类
- [ ] 实现create_mock_config方法
- [ ] 实现create_mock_metadata方法
- [ ] 实现create_sample_tensor方法
- [ ] 实现create_sample_batch方法
- [ ] 所有Mock对象结构与真实对象兼容

**输入**: 无  
**输出**: 完整的MockFactory类

### Task-003: 创建自测模板
**状态**: 待实现  
**需求引用**: FR-001  
**文件**: `src/utils/test_templates.py`  
**估算时间**: 1小时

**描述**: 创建标准化的自测代码模板，便于其他模块快速实现。

**验收标准**:
- [ ] 创建基础自测模板函数
- [ ] 创建工厂类自测模板
- [ ] 创建组件类自测模板
- [ ] 创建工具函数自测模板
- [ ] 包含完整的文档和示例

**输入**: SelfTestFramework, MockFactory  
**输出**: 各种自测模板

### Task-004: 框架集成测试
**状态**: 待实现  
**需求引用**: NFR-001, NFR-002  
**文件**: `test/test_self_test_framework.py`  
**估算时间**: 1小时

**描述**: 测试自测框架的功能完整性和性能。

**验收标准**:
- [ ] 验证框架基本功能
- [ ] 测试Mock对象创建
- [ ] 验证输出格式一致性
- [ ] 检查性能指标（<10秒执行时间）
- [ ] 测试异常处理机制

---

## 核心模块任务

### Task-005: data_factory.py自测实现
**状态**: 待实现  
**需求引用**: FR-002  
**文件**: `src/data_factory/data_factory.py`  
**估算时间**: 1.5小时

**描述**: 为data_factory添加自测功能，验证数据工厂的核心功能。

**验收标准**:
- [ ] 添加if __name__ == "__main__"块
- [ ] 测试data_factory函数导入
- [ ] 测试Mock配置创建数据加载器
- [ ] 验证可用数据读取器列表
- [ ] 测试基本的数据处理流程
- [ ] 验证与现有代码的兼容性

**输入**: 自测框架, Mock工厂  
**输出**: 完整的data_factory自测功能

**关键测试**:
```python
def test_factory_import()         # 导入测试
def test_mock_data_creation()     # Mock数据创建
def test_available_readers()      # 可用读取器
```

### Task-006: model_factory.py自测实现
**状态**: 待实现  
**需求引用**: FR-002  
**文件**: `src/model_factory/model_factory.py`  
**估算时间**: 1.5小时

**描述**: 为model_factory添加自测功能，验证模型工厂的创建逻辑。

**验收标准**:
- [ ] 添加if __name__ == "__main__"块
- [ ] 测试model_factory函数导入
- [ ] 测试Mock模型配置创建
- [ ] 验证可用模型类型列表
- [ ] 测试模型注册机制
- [ ] 验证ISFM组件兼容性

**输入**: 自测框架, Mock工厂  
**输出**: 完整的model_factory自测功能

### Task-007: task_factory.py自测实现
**状态**: 待实现  
**需求引用**: FR-002  
**文件**: `src/task_factory/task_factory.py`  
**估算时间**: 1.5小时

**描述**: 为task_factory添加自测功能，验证任务工厂的创建逻辑。

**验收标准**:
- [ ] 添加if __name__ == "__main__"块
- [ ] 测试task_factory函数导入
- [ ] 测试Mock任务配置创建
- [ ] 验证可用任务类型列表
- [ ] 测试任务注册机制
- [ ] 验证PyTorch Lightning集成

**输入**: 自测框架, Mock工厂  
**输出**: 完整的task_factory自测功能

### Task-008: trainer_factory.py自测实现
**状态**: 待实现  
**需求引用**: FR-002  
**文件**: `src/trainer_factory/trainer_factory.py`  
**估算时间**: 1小时

**描述**: 为trainer_factory添加自测功能，验证训练器工厂功能。

**验收标准**:
- [ ] 添加if __name__ == "__main__"块
- [ ] 测试trainer_factory函数导入
- [ ] 测试Mock训练器配置
- [ ] 验证可用训练器列表
- [ ] 测试基本的训练器创建
- [ ] 验证PyTorch Lightning兼容性

**输入**: 自测框架, Mock工厂  
**输出**: 完整的trainer_factory自测功能

### Task-009: loss.py组件自测实现
**状态**: 待实现  
**需求引用**: FR-002  
**文件**: `src/task_factory/Components/loss.py`  
**估算时间**: 1小时

**描述**: 为损失函数组件添加自测功能，验证各种损失函数。

**验收标准**:
- [ ] 添加if __name__ == "__main__"块
- [ ] 测试所有损失函数导入
- [ ] 测试CrossEntropy损失计算
- [ ] 测试MSE损失计算
- [ ] 测试其他损失函数（Focal, Triplet等）
- [ ] 验证损失值合理性

**输入**: 自测框架, Mock工厂, torch张量  
**输出**: 完整的loss组件自测功能

### Task-010: metrics.py组件自测实现
**状态**: 待实现  
**需求引用**: FR-002  
**文件**: `src/task_factory/Components/metrics.py`  
**估算时间**: 1小时

**描述**: 为度量组件添加自测功能，验证各种评估指标。

**验收标准**:
- [ ] 添加if __name__ == "__main__"块
- [ ] 测试所有度量函数导入
- [ ] 测试准确率计算
- [ ] 测试F1分数计算
- [ ] 测试其他度量（precision, recall等）
- [ ] 验证计算结果正确性

**输入**: 自测框架, Mock工厂, 预测和标签数据  
**输出**: 完整的metrics组件自测功能

---

## 扩展模块任务

### Task-011: data_processing.py工具自测
**状态**: 待实现  
**需求引用**: FR-002  
**文件**: `src/task_factory/utils/data_processing.py`  
**估算时间**: 1.5小时

**描述**: 为数据处理工具添加自测功能，验证核心数据处理算法。

**验收标准**:
- [ ] 添加if __name__ == "__main__"块
- [ ] 测试create_windows函数
- [ ] 测试normalize_data函数
- [ ] 测试process_sample函数
- [ ] 验证不同窗口策略
- [ ] 测试边界情况和异常处理

**输入**: 自测框架, Mock工厂, numpy数组  
**输出**: 完整的data_processing自测功能

### Task-012: config_utils.py工具自测
**状态**: 待实现  
**需求引用**: FR-002  
**文件**: `src/configs/config_utils.py`  
**估算时间**: 1小时

**描述**: 为配置工具添加自测功能，验证配置管理逻辑。

**验收标准**:
- [ ] 添加if __name__ == "__main__"块
- [ ] 测试load_config函数
- [ ] 测试ConfigWrapper类
- [ ] 测试配置合并和更新
- [ ] 验证预设配置加载
- [ ] 测试配置验证逻辑

**输入**: 自测框架, Mock配置文件  
**输出**: 完整的config_utils自测功能

### Task-013: Default_task.py任务自测
**状态**: 待实现  
**需求引用**: FR-002  
**文件**: `src/task_factory/Default_task.py`  
**估算时间**: 2小时

**描述**: 为Default_task添加自测功能，验证基础任务实现。

**验收标准**:
- [ ] 添加if __name__ == "__main__"块
- [ ] 测试Default_task类初始化
- [ ] 测试training_step方法
- [ ] 测试validation_step方法
- [ ] 测试configure_optimizers方法
- [ ] 验证与PyTorch Lightning集成

**输入**: 自测框架, Mock网络和配置  
**输出**: 完整的Default_task自测功能

### Task-014: regularization.py组件自测
**状态**: 待实现  
**需求引用**: FR-002  
**文件**: `src/task_factory/Components/regularization.py`  
**估算时间**: 1小时

**描述**: 为正则化组件添加自测功能，验证正则化方法。

**验收标准**:
- [ ] 添加if __name__ == "__main__"块
- [ ] 测试所有正则化方法导入
- [ ] 测试L1/L2正则化
- [ ] 测试Dropout正则化
- [ ] 测试域对抗正则化
- [ ] 验证正则化效果

**输入**: 自测框架, Mock模型参数  
**输出**: 完整的regularization自测功能

### Task-015: ISFM组件自测实现
**状态**: 待实现  
**需求引用**: FR-002  
**文件**: `src/model_factory/ISFM/M_01_ISFM.py` 等  
**估算时间**: 3小时

**描述**: 为ISFM核心组件添加自测功能。

**验收标准**:
- [ ] M_01_ISFM.py自测实现
- [ ] 主要embedding组件自测
- [ ] 主要backbone组件自测
- [ ] 主要task_head组件自测
- [ ] 验证组件间集成
- [ ] 测试形状兼容性

**输入**: 自测框架, Mock配置和数据  
**输出**: ISFM组件完整自测功能

---

## 验证和优化任务

### Task-016: 自测功能集成验证
**状态**: 待实现  
**需求引用**: NFR-001, NFR-003  
**文件**: `test/test_module_self_testing.py`  
**估算时间**: 2小时

**描述**: 验证所有模块的自测功能正常工作。

**验收标准**:
- [ ] 创建自动化测试脚本
- [ ] 验证所有自测模块可以运行
- [ ] 检查输出格式一致性
- [ ] 验证性能要求（<10秒）
- [ ] 测试异常处理
- [ ] 检查内存使用

**输入**: 所有实现自测的模块  
**输出**: 验证报告和测试脚本

### Task-017: 性能优化
**状态**: 待实现  
**需求引用**: NFR-001  
**文件**: 各个自测模块  
**估算时间**: 2小时

**描述**: 优化自测执行性能，确保满足时间和内存要求。

**验收标准**:
- [ ] 分析自测执行性能
- [ ] 优化缓慢的测试用例
- [ ] 减少内存占用
- [ ] 优化Mock对象创建
- [ ] 并行化可能的测试
- [ ] 验证性能基准达标

**输入**: 性能分析结果  
**输出**: 优化后的自测实现

### Task-018: 文档和使用指南
**状态**: 待实现  
**需求引用**: NFR-003  
**文件**: `docs/module_self_testing_guide.md`  
**估算时间**: 2小时

**描述**: 创建完整的自测功能使用指南和维护文档。

**验收标准**:
- [ ] 创建使用指南文档
- [ ] 说明自测框架使用方法
- [ ] 提供新模块添加自测的步骤
- [ ] 包含常见问题解答
- [ ] 提供维护和更新指南
- [ ] 包含最佳实践建议

**输入**: 完成的自测实现  
**输出**: 完整的文档和指南

### Task-019: 批量自测运行脚本
**状态**: 待实现  
**需求引用**: US-005  
**文件**: `scripts/run_all_self_tests.py`  
**估算时间**: 1.5小时

**描述**: 创建批量运行所有模块自测的脚本。

**验收标准**:
- [ ] 创建批量运行脚本
- [ ] 自动发现所有自测模块
- [ ] 并行执行多个自测
- [ ] 生成汇总报告
- [ ] 支持过滤和选择性运行
- [ ] 集成到CI/CD流程

**输入**: 所有自测模块列表  
**输出**: 批量运行脚本和报告生成器

### Task-020: 自测模板生成工具
**状态**: 待实现  
**需求引用**: NFR-004  
**文件**: `scripts/generate_self_test_template.py`  
**估算时间**: 1小时

**描述**: 创建自动生成自测代码模板的工具。

**验收标准**:
- [ ] 创建模板生成脚本
- [ ] 支持不同类型的模块模板
- [ ] 根据模块结构自动调整模板
- [ ] 生成符合标准的自测代码
- [ ] 提供交互式模板定制
- [ ] 集成到开发工作流

**输入**: 目标模块路径和类型  
**输出**: 自定义的自测代码模板

---

## 任务依赖关系

### 关键路径
```
Task-001 → Task-002 → Task-003 → Task-004 (框架建设)
    ↓
Task-005 → Task-006 → Task-007 → Task-008 (核心工厂)
    ↓
Task-009 → Task-010 → Task-014 (核心组件)
    ↓
Task-011 → Task-012 → Task-013 (工具和任务)
    ↓
Task-015 (ISFM组件) → Task-016 (集成验证)
    ↓
Task-017 → Task-018 → Task-019 → Task-020 (优化和工具)
```

### 并行任务组
- **框架任务**: Task-001, Task-002, Task-003 可以并行开发
- **核心模块**: Task-005至Task-008 可以并行实现
- **组件任务**: Task-009, Task-010, Task-014 可以并行实现
- **工具任务**: Task-011, Task-012 可以并行开发
- **验证任务**: Task-016至Task-020 依赖前面完成但可以并行进行

## 总体进度

### 任务统计
- **总任务数**: 20个
- **框架任务**: 4个（20%）
- **核心模块**: 6个（30%）
- **扩展模块**: 6个（30%）
- **验证优化**: 4个（20%）

### 工作量估算
- **框架建设**: 5.5小时
- **核心模块**: 8小时
- **扩展模块**: 8.5小时
- **验证优化**: 7.5小时
- **总计**: ~30小时

### 里程碑规划
1. **里程碑1**: 框架建设完成（Task-001至Task-004）
2. **里程碑2**: 核心模块自测完成（Task-005至Task-008）
3. **里程碑3**: 基础组件自测完成（Task-009至Task-010）
4. **里程碑4**: 扩展功能完成（Task-011至Task-015）
5. **里程碑5**: 验证和发布（Task-016至Task-020）

## 质量标准

### 代码质量要求
- **简洁性**: 每个自测函数不超过30行
- **可读性**: 清晰的函数名和注释
- **一致性**: 遵循统一的输出格式和错误处理
- **独立性**: 不依赖外部文件或网络资源

### 性能要求
- **执行时间**: 单个模块自测 < 10秒
- **内存使用**: < 100MB（不加载大型模型）
- **启动时间**: 框架初始化 < 2秒
- **并发安全**: 支持多个自测同时运行

### 测试覆盖要求
- **核心功能**: 必须测试模块的主要功能
- **典型用法**: 展示常见使用场景
- **边界情况**: 测试重要的边界条件
- **错误处理**: 验证异常情况的处理

## 风险管理

### 主要风险
1. **兼容性风险**: 新自测可能与现有代码冲突
2. **性能风险**: 某些模块自测可能执行缓慢
3. **维护风险**: 大量自测代码增加维护负担
4. **质量风险**: 简单自测可能无法发现复杂问题

### 缓解策略
- **渐进实施**: 分阶段实现，降低风险
- **充分测试**: 每个任务完成后立即验证
- **标准化**: 使用统一框架减少维护负担
- **性能监控**: 持续监控执行时间和资源使用

## 实施建议

### 开发策略
- **先框架后应用**: 优先建设框架，再实现具体模块
- **关键路径优先**: 优先完成核心依赖任务
- **质量优于数量**: 宁少勿滥，确保每个自测有价值
- **持续改进**: 根据使用反馈不断优化

### 团队协作
- **责任分工**: 明确每个任务的负责人
- **代码审查**: 所有自测代码必须经过审查
- **知识共享**: 定期分享实施经验和最佳实践
- **用户反馈**: 及时收集和响应开发者反馈