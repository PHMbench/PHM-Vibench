# 需求文档：模块自测环节功能

## 概述

本规范定义了为PHM-Vibench中所有Python模块添加 `if __name__ == "__main__"` 自测环节的需求，确保每个模块都具备独立的测试和验证能力，提高代码的可靠性和可维护性。

## 业务背景

### 问题陈述
虽然PHM-Vibench已经在107个模块中实现了自测功能，但仍有大量核心模块（工厂类、工具函数、组件等）缺少 `if __name__ == "__main__"` 自测环节。这导致：

1. **调试困难**：无法独立测试单个模块的功能
2. **开发效率低**：修改代码后需要运行完整系统才能验证
3. **代码质量不一致**：不同模块的测试标准不统一
4. **维护复杂**：缺乏模块级别的快速验证机制

### 业务价值
- **提高开发效率**：开发者可以独立测试单个模块，快速验证功能
- **增强代码可靠性**：每个模块都有基本的功能验证
- **简化调试过程**：便于定位问题和验证修复
- **统一代码质量**：建立一致的模块测试标准
- **改善开发体验**：遵循CLAUDE.md中的"模块自测试"原则

## 利益相关者

### 主要用户
- **PHM-Vibench开发者**：需要快速测试和验证代码修改
- **贡献者**：希望理解模块功能和正确使用方式
- **研究人员**：需要验证特定组件的行为

### 次要用户
- **系统维护者**：需要快速诊断和修复问题
- **新加入的开发者**：通过自测了解模块功能

## 用户故事

### US-001：独立模块测试
**作为** 开发者  
**我希望** 能够独立运行任何Python模块  
**以便** 快速验证该模块的核心功能是否正常  

**验收标准：**
- 当我运行 `python src/任意模块.py` 时
- 那么模块应该执行基本的功能演示
- 并且显示测试结果（成功/失败）
- 并且不依赖外部配置文件或数据

### US-002：工厂类功能验证
**作为** 开发者  
**我希望** 工厂类模块有自测功能  
**以便** 验证模型/任务/数据创建逻辑的正确性  

**验收标准：**
- 当我运行工厂模块时
- 那么应该展示创建不同组件的示例
- 并且验证注册机制是否正常工作
- 并且显示所有可用的组件列表

### US-003：组件功能演示
**作为** 研究人员  
**我希望** 损失函数、度量等组件模块有使用示例  
**以便** 理解如何正确使用这些组件  

**验收标准：**
- 当我运行组件模块时
- 那么应该展示典型的使用场景
- 并且包含输入输出示例
- 并且验证计算结果的正确性

### US-004：工具函数验证
**作为** 开发者  
**我希望** 工具函数模块有自测功能  
**以便** 验证核心算法和辅助函数的正确性  

**验收标准：**
- 当我运行工具模块时
- 那么应该测试主要函数的边界情况
- 并且展示函数的预期行为
- 并且验证性能特征（如内存使用）

### US-005：集成测试支持
**作为** 系统维护者  
**我希望** 自测功能能够发现集成问题  
**以便** 在不运行完整系统的情况下诊断问题  

**验收标准：**
- 当模块依赖发生变化时
- 那么自测应该能检测到兼容性问题
- 并且提供有用的错误信息
- 并且建议解决方案

## 功能需求

### FR-001：标准化自测框架
系统应为所有模块提供标准化的自测框架：
- 统一的测试输出格式
- 一致的成功/失败指示
- 标准化的测试用例结构
- 清晰的文档和示例

### FR-002：核心模块自测实现
系统应为关键模块添加自测功能：
- 所有工厂类（data_factory, model_factory, task_factory, trainer_factory）
- 核心组件（损失函数、度量、正则化）
- 工具函数和辅助模块
- 配置管理模块

### FR-003：分层测试策略
系统应支持不同层次的测试：
- **单元级别**：测试单个函数或类
- **模块级别**：测试模块内组件的交互
- **集成级别**：测试与其他模块的兼容性
- **示例级别**：提供典型使用场景

### FR-004：Mock和假数据支持
系统应提供用于测试的Mock对象和假数据：
- 模拟配置对象
- 生成测试用的张量数据
- 创建假的metadata对象
- 提供轻量级的依赖替代

### FR-005：测试结果报告
系统应生成结构化的测试结果：
- 清晰的成功/失败状态
- 详细的错误信息和堆栈跟踪
- 性能指标（执行时间、内存使用）
- 覆盖的测试案例列表

## 非功能需求

### NFR-001：执行性能
- **快速执行**：单个模块自测应在10秒内完成
- **轻量级**：不加载大型数据集或模型权重
- **内存效率**：使用最小的内存占用
- **并行安全**：支持多个模块同时进行自测

### NFR-002：依赖管理
- **最小依赖**：自测不依赖外部资源
- **隔离性**：不影响其他模块或系统状态
- **向后兼容**：与现有自测功能保持兼容
- **可选执行**：不影响模块的正常导入和使用

### NFR-003：代码质量
- **可读性**：自测代码清晰易懂
- **可维护性**：遵循统一的模式和标准
- **文档完整**：包含注释和使用说明
- **错误处理**：优雅处理异常情况

### NFR-004：开发体验
- **直观输出**：清晰的控制台输出格式
- **有用信息**：提供调试和使用提示
- **一致性**：所有模块使用相同的测试模式
- **可扩展性**：易于添加新的测试用例

## 技术约束

### TC-001：现有代码兼容性
- 必须与现有107个自测模块保持兼容
- 不能破坏现有的导入和使用方式
- 必须遵循现有的编码风格和模式
- 保持与PyTorch Lightning和其他框架的兼容性

### TC-002：框架集成约束
- 必须与PHM-Vibench工厂模式集成
- 支持ConfigWrapper配置系统
- 兼容现有的注册机制
- 遵循模块化设计原则

### TC-003：资源约束
- 不能依赖大型外部数据文件
- 避免加载预训练模型权重
- 最小化GPU内存使用
- 支持纯CPU环境执行

### TC-004：Python环境约束
- 兼容Python 3.8+
- 与现有依赖项兼容
- 支持不同的开发环境（本地、Docker、CI/CD）
- 遵循PEP 8编码规范

## 成功标准

### 验收测试
1. **功能完整性**：所有识别的缺失模块都有自测功能
2. **一致性验证**：所有自测遵循相同的模式和标准
3. **独立性验证**：每个模块可以独立运行和测试
4. **性能达标**：执行时间和内存使用满足要求

### 质量关卡
1. **代码审查**：所有自测代码通过审查
2. **文档完整**：提供清晰的使用和维护文档
3. **示例验证**：测试用例覆盖典型使用场景
4. **错误处理**：优雅处理各种异常情况

### 完成定义
- [ ] 核心工厂类模块实现自测功能
- [ ] 组件模块（损失、度量等）实现自测功能
- [ ] 工具函数模块实现自测功能
- [ ] 统一的自测框架和模板
- [ ] 完整的文档和使用指南
- [ ] 所有自测通过验证
- [ ] 性能基准达标

## 假设和依赖

### 假设
- 现有自测功能的模式是合适的基础
- 开发者愿意维护自测代码
- Mock数据可以有效替代真实数据
- 简单的测试用例足以验证核心功能

### 依赖
- PyTorch和相关ML框架
- PHM-Vibench现有配置系统
- Python标准库和测试工具
- 现有的注册和工厂机制

## 风险和缓解

### Risk-001：维护负担增加
**风险**：大量自测代码增加维护复杂性  
**影响**：中等 - 可能影响开发速度  
**缓解**：提供标准模板和自动化工具，简化自测代码编写

### Risk-002：测试覆盖不足
**风险**：简单的自测无法发现复杂问题  
**影响**：低 - 自测是补充而非替代全面测试  
**缓解**：明确自测的范围和目标，与正式测试套件配合使用

### Risk-003：执行性能问题
**风险**：某些模块的自测可能执行缓慢  
**影响**：中等 - 影响开发体验  
**缓解**：设定性能基准，使用轻量级替代和Mock对象

### Risk-004：兼容性问题
**风险**：新的自测可能与现有代码冲突  
**影响**：高 - 可能破坏现有功能  
**缓解**：渐进式实施，充分测试兼容性，保留回退方案

## 实施优先级

### 高优先级模块
1. **核心工厂类**：data_factory.py, model_factory.py, task_factory.py, trainer_factory.py
2. **关键组件**：loss.py, metrics.py, regularization.py
3. **工具函数**：data_processing.py, config_utils.py

### 中优先级模块
1. **任务实现**：Default_task.py, 各种特定任务
2. **模型组件**：embedding, backbone, task_head
3. **数据处理**：各种reader和dataset

### 低优先级模块
1. **辅助工具**：可视化、日志、实用函数
2. **实验脚本**：示例和演示代码
3. **配置文件**：模板和预设