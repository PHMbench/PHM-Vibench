# v0.1.0 更新总览（Config / Factory / Pipeline）

> 本文是 v0.1.0 的“收官版”更新说明，聚焦 **配置系统、工厂层结构、Pipeline 接口与 demo 验证**。  
> 设计草稿与详细 plan 已归档在 `docs/v0.1.0/done/` 中，本文件只保留最终落地结果。

---

## 1. 配置系统：统一的 base + demo 结构

### 1.1 不再使用 `__include__`，统一改为 `base_configs + override`

- 入口依然是 `python main.py --config <yaml>`；
- demo YAML 顶层统一增加：

  ```yaml
  base_configs:
    environment: "configs/base/environment/base.yaml"
    data: "configs/base/data/xxx.yaml"
    model: "configs/base/model/yyy.yaml"
    task: "configs/base/task/zzz.yaml"
    trainer: "configs/base/trainer/default_single_gpu.yaml"
  ```

- `load_config()` 负责：
  - 读取 demo YAML；
  - 若存在 `base_configs`：
    - 依次加载各 base yaml（内部已是嵌套结构：`environment/data/model/task/trainer`）；
    - 将 demo 顶层的 `environment/data/model/task/trainer` 视为 override；
    - 用“base 在前，override 在后”的合并策略生成最终 `ConfigWrapper`；
  - 最终统一暴露：`cfg.environment / cfg.data / cfg.model / cfg.task / cfg.trainer`。

### 1.2 base YAML 目录与职责

- `configs/base/environment/base.yaml`
  - 统一提供环境字段（仅保留 `PROJECT_HOME`，不再依赖 `VBENCH_HOME`）：

    ```yaml
    environment:
      PROJECT_HOME: "/home/user/LQ/B_Signal/Signal_foundation_model/Vbench"
      project: "demo_project"
      seed: 42
      output_dir: "results/demo"
      notes: ""
      iterations: 1
    ```

- `configs/base/data/*.yaml`（所有数据统一使用 metadata.xlsx）
  - 示例：
    - `base_classification.yaml`
    - `base_cross_domain.yaml`
    - `base_cross_system.yaml`
    - `base_fewshot.yaml`
    - `base_cross_system_fewshot.yaml`
  - 共同约定：

    ```yaml
    data:
      data_dir: "/home/user/data/PHMbenchdata/PHM-Vibench"
      metadata_file: "metadata.xlsx"
      batch_size: 256
      num_workers: 8
      train_ratio: 0.8
      val_ratio: 0.1
      test_ratio: 0.1
      normalization: "standardization"
      window_size: ...
      stride: ...
      num_window: ...
      dtype: "float32"
      pin_memory: true
    ```

- `configs/base/model/backbone_dlinear.yaml`
  - v0.1.0 的 demo 模型统一为 ISFM + HSE + DLinear + 线性分类头：

    ```yaml
    model:
      name: "M_01_ISFM"
      type: "ISFM"
      embedding: "E_01_HSE"
      backbone: "B_04_Dlinear"
      task_head: "H_01_Linear_cla"
    ```

- `configs/base/task/*.yaml`
  - 只使用已有字段，不创造新 key，分别覆盖典型任务：
    - `classification.yaml`（单数据集分类 / 简单 DG）
    - `dg.yaml`（cross-domain DG）
    - `cddg.yaml`（多系统 CDDG）
    - `fewshot.yaml`（单系统 FS）
    - `cddg_fewshot.yaml`（跨系统 GFS few-shot）
    - `pretrain.yaml`（预训练任务基础配置）

- `configs/base/trainer/default_single_gpu.yaml`
  - 提供统一的单 GPU 训练器配置（max_epochs / device / monitor / early_stopping 等），demo 中只需局部 override。

### 1.3 Config Registry：统一索引表

- 新增 `configs/config_registry.csv`：
  - 以 CSV 形式记录 base 与 demo 配置的路径和组合关系；
  - 字段示例：

    ```csv
    id,category,path,description,pipeline,base_environment,base_data,base_model,base_task,base_trainer,status
    base_data_classification,base_data,configs/base/data/base_classification.yaml,"单数据集分类 / DG data base",,,,,,/
    demo_01_cross_domain,demo,configs/demo/01_cross_domain/cwru_dg.yaml,"Cross-domain DG demo",Pipeline_01_default,...
    ```

  - 6 个 demo（见第 4 节）均已标记 `status = sanity_ok`。

---

## 2. Model Factory / Task Factory：文档与索引表

### 2.1 模型侧

- `src/model_factory/model_registry.csv`
  - 记录“模型级别”的信息：
    - `model.type`, `model.name`, `module_path`, `args`, `notes`, `test_status`；
  - ISFM 组件级信息从模型表中拆出。

- `src/model_factory/ISFM/isfm_components.csv`
  - 专门描述 ISFM 的三类组件：
    - `embedding`（E\_xx\_*）
    - `backbone`（B\_xx\_*）
    - `task_head`（H\_xx\_*）
  - 字段：`component_type, component_id, module_path, key_args, args, notes, test_status`。

- 文档更新：
  - `src/model_factory/README.md` / `README_CN.md`：
    - 统一说明：`model.type + model.name` 决定导入路径；
    - 指向 `model_registry.csv` 和 `isfm_components.csv` 作为权威索引。
  - `src/model_factory/ISFM/README.md`：
    - 详述 ISFM 组合方式，给出 HSE + DLinear + Linear_cla 示例配置。

### 2.2 任务侧

- `src/task_factory/task_registry.csv`
  - 统一记录 Task 与 Dataset 的组合关系：

    ```csv
    id,task.type,task.name,path,args,dataset_path,dataset_args,batch_format,notes,test_status
    3,DG,classification,task/DG/classification.py,...,dataset_task/DG/Classification_dataset.py,...
    4,CDDG,classification,task/CDDG/classification.py,...,dataset_task/CDDG/classification_dataset.py,...
    10,FS,prototypical_network,task/FS/prototypical_network.py,...,dataset_task/FS/Classification_dataset.py,...
    14,GFS,classification,task/GFS/classification.py,...,dataset_task/GFS/Classification_dataset.py,...
    ```

- 文档更新：
  - `src/task_factory/readme.md` / `README_CN.md`：
    - 说明 `task.type` / `task.name` 如何映射到 `src.task_factory.task.{type}.{name}`；
    - 提醒完整表在 `task_registry.csv` 中维护。
  - `src/data_factory/dataset_task/README.md` / `README_CN.md`：
    - 解释 `dataset_task` 层的作用；
    - 将 task ↔ dataset 映射统一指向 `task_registry.csv`。

---

## 3. Pipeline 与环境变量：去除 VBENCH 依赖

### 3.1 main.py 与 Pipeline 入口

- `main.py` 统一入口：
  - 推荐参数：`--config <yaml 或预设名>`；
  - 兼容旧的 `--config_path`，但内部统一写回 `args.config_path`；
  - 从 YAML 顶层读取：
    - `pipeline: "Pipeline_01_default"` 或
    - `pipeline: { name: "Pipeline_02_pretrain_fewshot" }`；
  - 动态导入对应 `src.Pipeline_XX` 模块，并调用 `pipeline(args)`。

### 3.2 Pipeline_01_default：只依赖 PROJECT_HOME

- 不再访问 `VBENCH_HOME` / `VBENCH_DATA`；
- 使用 `cfg.environment` 构造 `args_environment`，将其中大写字段写入 `os.environ`（例如 `PROJECT_HOME`）；
- 结果目录通过 `environment.output_dir + path_name(cfg, it)` 组合创建；
- 支持 `base_configs + override` 生成的 `ConfigWrapper`。

### 3.3 Pipeline_02_pretrain_fewshot：单阶段 + 多阶段

- 行为调整：
  - 若 YAML 顶层无 `stages`：
    - 视为“单阶段配置”，调用 `_run_single_stage_from_cfg(cfg)`，与 Pipeline_01_default 接近；
  - 若包含 `stages` 列表（参考 `experiment_2_cddg_hse_pretrain.yaml`）：
    - 由 `TwoStageOrchestrator` 解析 `stages`，按 stage 依次运行 pretrain / finetune；
    - 支持 CLI 覆盖参数（`--override`）作用在多阶段配置上。
- 环境变量处理同样仅通过 `PROJECT_HOME` 等大写字段完成。

---

## 4. 6 个代表性 demo 配置与验证

v0.1.0 定义了 6 个 demo，均采用 `base_configs + override` 结构，模型统一为 ISFM + HSE + DLinear + Linear_cla，并通过以下命令完成最小 sanity 验证（`num_workers=0`，单 epoch）：

```bash
python main.py --config <demo_yaml> --override trainer.num_epochs=1 --override data.num_workers=0
```

### 4.1 demo 列表与状态

1. **demo_01_cross_domain** — Cross-domain DG（单数据集 DG 示例）  
   - YAML：`configs/demo/01_cross_domain/cwru_dg.yaml`  
   - Task：`type="DG", name="classification"`  
   - Pipeline：`Pipeline_01_default`  
   - 状态：`sanity_ok`

2. **demo_02_cross_system** — Cross-system CDDG（多系统 CDDG 示例）  
   - YAML：`configs/demo/02_cross_system/multi_system_cddg.yaml`  
   - Task：`type="CDDG", name="classification"`（含 `target_system_id/target_domain_num`）  
   - Pipeline：`Pipeline_01_default`  
   - 状态：`sanity_ok`

3. **demo_03_fewshot** — Few-shot demo（单系统 FS 示例）  
   - YAML：`configs/demo/03_fewshot/cwru_protonet.yaml`  
   - Task：`type="FS", name="classification"`，使用 `configs/base/task/fewshot.yaml` 作为 base  
   - 数据：`base_fewshot.yaml`（window 较小）  
   - Pipeline：`Pipeline_01_default`  
   - 状态：`sanity_ok`

4. **demo_04_cross_system_fewshot** — Cross-system few-shot demo（跨系统 GFS 示例）  
   - YAML：`configs/demo/04_cross_system_fewshot/cross_system_tspn.yaml`  
   - Task：`type="GFS", name="classification"`，使用 `configs/base/task/cddg_fewshot.yaml` 作为 GFS base  
   - 数据：`base_cross_system_fewshot.yaml`  
   - Pipeline：`Pipeline_01_default`  
   - 状态：`sanity_ok`

5. **demo_05_pretrain_fewshot** — Pretrain + few-shot demo（当前为单阶段 HSE 对比预训练示例）  
   - YAML：`configs/demo/05_pretrain_fewshot/pretrain_hse_then_fewshot.yaml`  
   - Task：`type="pretrain", name="hse_contrastive"` + `target_system_id/target_domain_num`  
   - Pipeline：`Pipeline_02_pretrain_fewshot`（无 `stages`，走单阶段路径）  
   - 状态：`sanity_ok`

6. **demo_06_pretrain_cddg** — Pretrain HSE for CDDG demo（单阶段预训练视角）  
   - YAML：`configs/demo/06_pretrain_cddg/pretrain_hse_cddg.yaml`  
   - Task：`type="pretrain", name="hse_contrastive"` + 单系统 `target_system_id=[1]`  
   - Pipeline：`Pipeline_01_default`  
   - 状态：`sanity_ok`

详细的验证日志、指标片段与注意事项已归档在 `docs/v0.1.0/done/demo_validation_report.md`。

---

## 5. FS / GFS / Pretrain 行为修复

### 5.1 FS：单系统 few-shot 分类（不暴露具体算法名）

- 配置层统一：
  - `task.type: "FS"`
  - `task.name: "classification"`
  - few-shot 超参：`n_way / k_shot / q_query / episodes_per_epoch / lr`。
  - 具体 few-shot 算法（ProtoNet / MatchingNet 等）视为模型层概念，不在 v0.1.0 的 `task.name` 中暴露。

- ID 搜索：

  ```python
  elif args_task.type == 'FS':
      train_val_ids, test_ids = list(metadata_accessor.keys()), list(metadata_accessor.keys())
  ```

- Sampler：
  - FS 使用 `Same_system_Sampler`，在单系统范围内构建系统内批次；
  - DataLoader 仍返回窗口级 batch，任务实现使用 `FS/classification.py`（继承 `Default_task`）。

### 5.2 GFS：跨系统 few-shot（广义 few-shot）

- GFS base（`configs/base/task/cddg_fewshot.yaml`）：
  - `task.type="GFS", task.name="classification"`；
  - 补全 `num_episodes/num_systems/num_domains/num_labels/num_support/num_query` 等字段；
  - 任务实现：`task/GFS/classification.py`，数据实现：`dataset_task/GFS/Classification_dataset.py`。

- Sampler：
  - `Get_sampler` 对 `task.type == "GFS"` 使用 `HierarchicalFewShotSampler`，按系统→域→标签构建 episode。

### 5.3 Pretrain：统一为 `type="pretrain", name="hse_contrastive"` 路径

- 任务实现集中在：`src/task_factory/task/pretrain/hse_contrastive.py`；
- demo5/6 均通过 `type="pretrain", name="hse_contrastive"` 调用该任务，不再错误指向 `CDDG/hse_contrastive`；
- ID 搜索对 pretrain 类型统一走“全部 ID”的策略。

---

## 6. 文档与 plan 归档

为避免 v0.1.0 之后的演进混淆，把本轮使用的 plan / 设计草稿集中归档到：

- `docs/v0.1.0/done/`
  - `pipeline_fix_and_validation_plan.md`（Pipeline 修复 + 6 demo 验证 plan）
  - `config_registry_plan.md`（config registry 设计）
  - `demo_validation_report.md`（完整验证报告）
  - `fewshot_gfs_fix_plan.md`（FS/GFS 修复方案）
  - `model_factory_plan.md`（模型工厂文档/索引设计）
  - `task_factory_task_mapping_plan.md`（任务侧 mapping 设计）

同时对旧设计文档加了说明：

- `docs/v0.1.0/configupdate.md`：
  - 标记为“设计文档”，提醒最终以 `v0.1.0_update.md` 与 `done/` 中内容为准。
- `docs/v0.1.0/release_v0.1.0_planning.md`：
  - 将 TODO 列表更新为 checklist，记录已完成的配置/验证工作；
  - 保留一项待办：在真实 Git 流程中基于 `release/v0.1.0` 整合其他分支。

---

## 7. 后续工作建议（v0.1.x / v0.2.0）

不强制在 v0.1.0 内完成，但可以作为下一阶段的迭代方向存档：

- 为 6 个 demo 在 `configs/demo/` 下补一份简短 README（命令 + 任务说明 + 预期输出）；
- 将 FS 的 episodic Dataset / sampler（`episode_dataset` + few-shot 算法）整理成清晰的模型层接口，在未来版本中开放；
- 在 `paper/2025-10_foundation_model_0_metric/` 下对照 reference experiments，把 demo 配置与论文实验一一对应起来；
- 针对核心流水线补充少量单元测试 / 集成测试（尤其是 `load_config` / `TwoStageOrchestrator` / FS/GFS sampler 的边界情况）。 
