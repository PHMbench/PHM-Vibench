# Experiment 2 (CDDG view): HSE Contrastive Pretraining + CDDG Finetuning
# 对应 unified 配置：configs/experiment_2_unified.yaml

environment:
  VBENCH_HOME: "/home/user/LQ/B_Signal/Signal_foundation_model/Vbench"
  project: "experiment_2_cddg_hse_pretrain"
  seed: 42
  output_dir: "paper/2025-10_foundation_model_0_metric/results/cddg/exp2_hse_pretrain"
  notes: "Experiment 2 (CDDG): HSE contrastive pretraining + CDDG finetuning (two stages)"
  iterations: 1

data:
  data_dir: "/home/user/data/PHMbenchdata/PHM-Vibench"
  metadata_file: "metadata.xlsx"
  batch_size: 1024
  num_workers: 32
  train_ratio: 0.8
  val_ratio: 0.1
  test_ratio: 0.1
  normalization: "standardization"
  window_size: 4096
  stride: 5
  dtype: "float32"
  pin_memory: true

model:
  name: "M_01_ISFM"
  type: "ISFM"
  embedding: "E_01_HSE"
  backbone: "B_04_Dlinear"
  task_head: "H_01_Linear_cla"

  system_embedding_dim: 64
  sample_embedding_dim: 32
  hierarchical_levels: 3
  patch_size_L: 64
  patch_size_C: 1
  num_patches: 32
  use_prompt: false
  prompt_dim: 0
  output_dim: 128

task:
  type: "CDDG"
  name: "hse_contrastive"
  loss: "INFONCE"
  contrast_loss: "INFONCE"
  contrast_weight: 1.0
  classification_weight: 0.1
  temperature: 0.07
  optimizer: "adamw"
  weight_decay: 0.0001
  lr: 0.0005
  scheduler: "cosine"
  early_stopping: true
  patience: 10
  metrics: ["acc", "f1", "precision", "recall"]
  target_system_id: [1, 13, 6, 12, 19]
  target_domain_num: 1

trainer:
  name: "Default_trainer"
  max_epochs: 200
  devices: 1
  accelerator: "cuda"
  device: "cuda"
  precision: 32
  check_val_every_n_epoch: 5
  deterministic: true
  gradient_clip_val: 1.0
  accumulate_grad_batches: 1
  save_checkpoints: true
  log_every_n_steps: 50

stages:
  - name: "pretraining"
    description: "HSE contrastive pretraining (CDDG view, pretrain stage)"
    overrides:
      task:
        type: "pretrain"
        name: "hse_contrastive"
        loss: "INFONCE"
        contrast_loss: "INFONCE"
        contrast_weight: 1.0
        classification_weight: 0.1
        temperature: 0.07
      trainer:
        max_epochs: 200
        save_dir: "results/experiment_2_unified/pretrain"
        check_val_every_n_epoch: 5
        early_stopping: false
      data:
        num_window: 256
        stride: 32
        shuffle: true
        drop_last: true
      environment:
        stage_name: "pretraining"
        project: "experiment_2_cddg_pretrain"

  - name: "finetuning"
    description: "CDDG classification finetuning after HSE pretraining"
    overrides:
      model:
        training_stage: "finetune"
      task:
        type: "CDDG"
        name: "classification"
        loss: "CE"
        classification_weight: 1.0
        contrast_weight: 0.1
        temperature: 0.1
        lr: 0.0001
        weight_decay: 0.00001
        optimizer: "adamw"
        scheduler: "step"
        step_size: 10
        gamma: 0.1
        target_system_id: [1, 13, 6, 12, 19]
        cross_domain: true
      trainer:
        max_epochs: 200
        save_dir: "results/experiment_2_unified/finetune"
        check_val_every_n_epoch: 2
        early_stopping: true
        patience: 8
      data:
        num_window: 64
        stride: 8
        shuffle: true
        drop_last: false
      environment:
        stage_name: "finetuning"
        project: "experiment_2_cddg_finetune"

pipeline:
  name: "Pipeline_02_pretrain_fewshot"
